name: Daily Collect

on:
  schedule:
    # UTC 09:00 = KST 18:00 (한국 장 마감 후)
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date override (YYYY-MM-DD). Default: T-7"
        required: false
      end_date:
        description: "End date override (YYYY-MM-DD). Default: today"
        required: false

jobs:
  collect-and-analyze:
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
      ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
      PYTHONUTF8: 1

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/pyproject.toml

      - name: Install dependencies
        working-directory: backend
        run: pip install -e .

      - name: Compute date range
        id: dates
        run: |
          START="${{ github.event.inputs.start_date }}"
          END="${{ github.event.inputs.end_date }}"
          if [ -z "$START" ]; then
            START=$(python -c "from datetime import date,timedelta; print((date.today()-timedelta(days=7)).isoformat())")
          fi
          if [ -z "$END" ]; then
            END=$(python -c "from datetime import date; print(date.today().isoformat())")
          fi
          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "end=$END" >> "$GITHUB_OUTPUT"
          echo "Date range: $START ~ $END"

      - name: Collect OHLCV data
        working-directory: backend
        run: python scripts/collect.py --start ${{ steps.dates.outputs.start }} --end ${{ steps.dates.outputs.end }}

      - name: Healthcheck (data freshness)
        working-directory: backend
        continue-on-error: true
        run: python scripts/healthcheck.py

      - name: Run research pipeline
        working-directory: backend
        run: python scripts/run_research.py --start ${{ steps.dates.outputs.start }} --end ${{ steps.dates.outputs.end }}

name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/test_db
      PYTHONUTF8: 1

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/pyproject.toml

      - name: Install dependencies
        working-directory: backend
        run: pip install -e ".[dev]"

      - name: Lint (ruff)
        working-directory: backend
        run: ruff check .

      - name: Run tests
        working-directory: backend
        run: python -m pytest --tb=short -q

  deploy-railway:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        id: railway-deploy
        working-directory: backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          OUTPUT=$(railway up --ci --service backend 2>&1) || true
          echo "$OUTPUT"
          # Extract deployment ID from build logs URL
          DEPLOY_ID=$(echo "$OUTPUT" | grep -oP 'id=\K[a-f0-9-]+' | head -1)
          echo "deploy_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"
          # Check if deploy succeeded
          if echo "$OUTPUT" | grep -q "Deploy failed"; then
            echo "deploy_failed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch Railway runtime logs
        if: always()
        working-directory: backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          DEPLOY_ID="${{ steps.railway-deploy.outputs.deploy_id }}"
          echo "Deployment ID: $DEPLOY_ID"
          if [ -n "$DEPLOY_ID" ]; then
            railway logs "$DEPLOY_ID" 2>&1 || echo "Could not fetch logs for deployment"
          fi
          # Also try without deployment ID
          railway logs 2>&1 || echo "Could not fetch recent logs"

      - name: Fail if deploy failed
        if: steps.railway-deploy.outputs.deploy_failed == 'true'
        run: exit 1

  deploy-vercel:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
